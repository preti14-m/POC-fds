name: Deploy Sample .NET Core to IIS on Azure VM

env:
  DOTNET_VERSION: '6.0.x'
  PROJECT_PATH: 'SampleDotNetApp/SampleDotNetApp.csproj'
  SOLUTION_PATH: 'SampleDotNetApp.sln'
  PUBLISH_FOLDER: 'publish_output'

on:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  build-publish:
    name: Build and Publish .NET App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET Dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build .NET Application
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Publish .NET Application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --output ${{ env.PUBLISH_FOLDER }}

      - name: Upload Published Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-app-publish
          path: ${{ env.PUBLISH_FOLDER }}
          retention-days: 1

  deploy-to-iis-vm:
    name: Deploy to IIS on Azure VM
    runs-on: ubuntu-latest
    needs: build-publish

    steps:
      - name: Download Published Artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-app-publish
          path: ./downloaded_app

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}


      - name: Test SSH connection with verbose logging
        run: ssh -vvv -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "hostname"

      - name: Copy and Deploy to IIS
        run: |
          echo "Stopping IIS Site..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} 'powershell.exe -Command "Stop-WebSite -Name \"${{ secrets.IIS_SITE_NAME }}\""'

          echo "Copying files to remote IIS site directory..."
          scp -r -o StrictHostKeyChecking=no ./downloaded_app/* ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.IIS_SITE_PATH }}/

          echo "Starting IIS Site..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} 'powershell.exe -Command "Start-WebSite -Name \"${{ secrets.IIS_SITE_NAME }}\""'
